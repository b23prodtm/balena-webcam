ARG TARGETPLATFORM
ARG MTX_WEBRTCADDITIONALHOSTS
FROM balenalib/intel-nuc-alpine-golang

ENV TARGETPLATFORM ${TARGETPLATFORM:-'linux/amd64'}
ENV MTX_WEBRTCADDITIONALHOSTS ${MTX_WEBRTCADDITIONALHOSTS:-'192.168.1.17â€™}
#RUN [ "cross-build-start" ]

RUN apk add --no-cache \
    ffmpeg

WORKDIR /
# We used to build our own binaries (bluenviron/mediamtx) but we can't pull source code on demand yet !
# TODO: the deploy-to-fleet function should allow submodule checkout
COPY $TARGETPLATFORM/. /
COPY rtsp-simple-server.yml /mediamtx.yml
RUN sed -i.orig "/s/videosurveillance/${MTX_WEBRTCADDITIONALHOSTS}/g" /mediamtx.yml
RUN chmod +x /mediamtx
#RUN [ "cross-build-end" ]

ENTRYPOINT [ "/mediamtx" ]